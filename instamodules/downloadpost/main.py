import json,requests,datetime
headers={
    'user-agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.82 Safari/537.36',
    'accept':'*/*'
}

class DownloadPost:
    def main():
        print('\nDownload A Public Post')
        print('======================\n')
        url = input("[ URL ]  ➜  ")
        while not url:
            url = input("[ URL ]  ➜  ")
        ses = requests.session()
        rq = ses.get(url=url,headers=headers)
        for line in rq.text.split('\n'):
            if 'src' in line and ('display_url' in line or 'display_src' in line):
                l_indexes = [x for x, v in enumerate(line) if v == '{']
                r_indexes = [x for x, v in enumerate(line) if v == '}']
                d = json.loads(line[l_indexes[0]:r_indexes[len(r_indexes)-1]+1])


                if 'video_url' in d['entry_data']['PostPage'][0]['graphql']['shortcode_media']:
                    url = d['entry_data']['PostPage'][0]['graphql']['shortcode_media']['video_url']
                    ftype = 'mp4'
                else:
                    url = d['entry_data']['PostPage'][0]['graphql']['shortcode_media']['display_url']
                    ftype = 'jpg'


                print(f'    > Full link found! downloading..')
                rq2 = ses.get(url=url,headers=headers,cookies=rq.cookies)


                date_time = datetime.datetime.now().strftime("%m-%d-%Y_%H-%M-%S")
                with open(f'{date_time}.{ftype}', 'wb') as f:
                    print(f'    > writing to file \'{date_time}.{ftype}\'')
                    for chunk in rq2.iter_content(chunk_size=1024):
                        if chunk:
                            f.write(chunk)
